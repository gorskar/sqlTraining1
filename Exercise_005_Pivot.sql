-- 005 PIVOT EXERCISE

-- We have some flattened 2d data (Created with the Script SqlTrainingSetup_005_CreatePresureAndDistance)
-- Have a look with the query below...
--
 SELECT * FROM PressureAndDistance
--
-- Now... We would like to unflatten that data, so that the columns are [Time], [Unit], [ItemIndex], [0], [43.0703125], [86.140625], .... 
-- and every distinct distance up to [5513], so that we are viewing a 2D profile of pressure down this pipe
--
-- The data should look like this:
--
--Time	Unit	ItemIndex	0.0E0	43.0703125	86.140625	129.2109375	172.28125	215.3515625	258.421875	344.5625	516.84375	689.125	861.40625	1033.6875	1378.25	1722.8125	2067.375	2756.5	3445.625	4134.75	5513
--2020-10-29 01:01:00.000	barg	987	142.878082275391	NULL	NULL	NULL	142.922836303711	NULL	142.945526123047	142.968383789063	143.014556884766	143.061248779297	143.108383178711	143.155853271484	143.251663208008	143.348297119141	143.445541381836	143.64111328125	143.837600708008	144.034545898438	144.428955078125
--2020-10-29 01:02:00.000	barg	987	142.924591064453	NULL	NULL	NULL	142.966796875	NULL	142.988265991211	143.00993347168	143.053741455078	143.098114013672	143.142944335938	143.188186645508	143.279571533203	143.371932983398	143.465057373047	143.652847290039	143.842193603516	144.032653808594	144.416030883789
--2020-10-29 01:03:00.000	barg	987	142.902435302734	NULL	NULL	NULL	142.945434570313	NULL	142.967315673828	142.989334106445	143.033782958984	143.078735351563	143.124099731445	143.169815063477	143.262115478516	143.355316162109	143.44921875	143.638458251953	143.829071044922	144.020553588867	144.405197143555
--2020-10-29 01:04:00.000	barg	987	142.845657348633	NULL	NULL	NULL	142.889007568359	NULL	142.911056518555	142.933258056641	142.978088378906	143.023391723633	143.069107055664	143.115173339844	143.208145141602	143.302032470703	143.396606445313	143.587173461914	143.779113769531	143.971893310547	144.359008789063
--2020-10-29 01:05:00.000	barg	987	142.765167236328	NULL	142.786727905273	NULL	142.808670043945	142.819732666016	142.830856323242	142.853225708008	142.898345947266	142.943954467773	142.989944458008	143.036285400391	143.129806518555	143.224227905273	143.3193359375	143.510986328125	143.703964233398	143.89778137207	144.28694152832
--2020-10-29 01:06:00.000	barg	987	142.737533569336	NULL	142.758773803711	NULL	142.780410766602	142.79133605957	142.802322387695	142.824417114258	142.869064331055	142.914184570313	142.959716796875	143.005584716797	143.098175048828	143.191711425781	143.28596496582	143.475997924805	143.667526245117	143.860015869141	144.246932983398
--2020-10-29 01:07:00.000	barg	987	142.735946655273	NULL	142.757095336914	NULL	142.778625488281	142.789505004883	142.800445556641	142.822463989258	142.866943359375	142.911926269531	142.957305908203	143.003005981445	143.095245361328	143.188400268555	143.282241821289	143.471405029297	143.661987304688	143.853500366211	144.238357543945
--2020-10-29 01:08:00.000	barg	987	142.688461303711	NULL	142.709884643555	NULL	142.731643676758	142.742645263672	142.753707885742	142.775970458984	142.82096862793	142.866455078125	142.912322998047	142.958526611328	143.051681518555	143.145690917969	143.240356445313	143.431030273438	143.622985839844	143.815734863281	144.202697753906
--2020-10-29 01:09:00.000	barg	987	142.632461547852	NULL	142.653854370117	NULL	142.675628662109	142.686614990234	142.697677612305	142.719924926758	142.764923095703	142.810440063477	142.856353759766	142.902572631836	142.995834350586	143.089965820313	143.184753417969	143.375732421875	143.568084716797	143.761306762695	144.149383544922
--2020-10-29 01:10:00.000	barg	987	142.635482788086	NULL	142.656555175781	NULL	142.678009033203	142.688842773438	142.699737548828	142.721664428711	142.766052246094	142.810974121094	142.856323242188	142.901992797852	142.994155883789	143.087188720703	143.180938720703	143.369918823242	143.56037902832	143.751846313477	144.136779785156
























































-- ANSWER

/*

DECLARE @tDistances TABLE(DistanceIndex INT IDENTITY(1,1), Distance FLOAT)

INSERT @tDistances(Distance)
SELECT DISTINCT(Distance) FROM PressureAndDistance ORDER BY Distance

DECLARE @SQL NVARCHAR(MAX)
DECLARE @columns NVARCHAR(MAX) = ''
SELECT @columns += QUOTENAME(CONVERT(NVARCHAR(23), Distance, 128)) + ',' FROM @tDistances ORDER BY DistanceIndex
SET @columns = LEFT(@columns, LEN(@columns) - 1)


-- Get the data with PIVOT columns for distance
SELECT @SQL =
'SELECT pvt.*
FROM
(
	SELECT Distance, [Time], [Unit], ItemIndex, LoggedValue
	FROM PressureAndDistance
) d
PIVOT
(
	MIN(LoggedValue)
	FOR Distance IN (' + @columns + ')
) AS pvt
ORDER BY [Time]'

EXEC sp_executeSql @SQL


*/